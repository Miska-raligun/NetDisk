<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mio's Netdisk - æ§åˆ¶å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .deleted-user {
            color: red;
            text-decoration: line-through;
        }
        .progress-bar {
            width: 100%;
            background: #eee;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress {
            height: 100%;
            background: green;
        }
    </style>
    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('input[name="files"]');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function toggleAllFolders(source) {
            const checkboxes = document.querySelectorAll('.folder-checkbox');
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = source.checked;
            });
        }

        async function handleDownload(encoded, cell) {
            try {
                const response = await fetch(`/api/download/${encoded}`, { method: 'POST' });
                const url = await response.text();
                cell.innerText = parseInt(cell.innerText) + 1;
                window.location.href = url;
            } catch (e) {
                alert("ä¸‹è½½å¤±è´¥");
            }
        }

        async function changeOwnPassword() {
            const username = "{{ username }}";
            const oldPassword = prompt("è¯·è¾“å…¥åŸå¯†ç ï¼š");
            if (!oldPassword) return;

            // ç¬¬ä¸€æ­¥ï¼šå…ˆéªŒè¯åŸå¯†ç 
            const checkForm = new FormData();
            checkForm.append("username", username);
            checkForm.append("old_password", oldPassword);

            const verifyResp = await fetch("{{ url_for('verify_password') }}", {
                method: "POST",
                body: checkForm
            });

            if (!verifyResp.ok) {
                alert("âŒ åŸå¯†ç é”™è¯¯ï¼Œä¿®æ”¹å¤±è´¥ï¼");
                return;
            }

            // ç¬¬äºŒæ­¥ï¼šç¡®è®¤æ–°å¯†ç 
            const newPassword = prompt("è¯·è¾“å…¥æ–°å¯†ç ï¼š");
            if (!newPassword) return;

            const formData = new FormData();
            formData.append("username", username);
            formData.append("old_password", oldPassword);
            formData.append("new_password", newPassword);

            const response = await fetch("{{ url_for('change_password') }}", {
                method: "POST",
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else {
                alert("ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        function sortTable(colIndex, asc = true) {
            const table = document.querySelector("table");
            const rows = Array.from(table.tBodies[0].rows);

            rows.sort((a, b) => {
                let aText = a.cells[colIndex]?.innerText.trim();
                let bText = b.cells[colIndex]?.innerText.trim();

                // ç»Ÿä¸€è½¬æ•°å­—å°è¯•
                const aVal = parseFloat(aText.replace(/[^0-9.]/g, '')) || aText;
                const bVal = parseFloat(bText.replace(/[^0-9.]/g, '')) || bText;

                if (aVal < bVal) return asc ? -1 : 1;
                if (aVal > bVal) return asc ? 1 : -1;
                return 0;
            });

            for (const row of rows) {
                table.tBodies[0].appendChild(row); // é‡æ–°æ’å…¥æ’åºåè¡Œ
            }
        }

        function confirmDeleteFolder(folder, user) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ ${folder} å—ï¼Ÿ`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('delete_folder') }}";

                const folderInput = document.createElement('input');
                folderInput.name = 'folder';
                folderInput.value = folder;
                folderInput.type = 'hidden';

                const userInput = document.createElement('input');
                userInput.name = 'user';
                userInput.value = user;
                userInput.type = 'hidden';

                form.appendChild(folderInput);
                form.appendChild(userInput);
                document.body.appendChild(form);
                form.submit();
            }
        }

        async function handleMultiDownload() {
            const checkboxes = document.querySelectorAll('input[name="files"]:checked');
            const downloadBtn = document.getElementById('multiDownloadBtn');
            const statusText = document.getElementById('downloadStatus');

            if (checkboxes.length === 0) {
                alert("è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶ï¼");
                return;
            }

            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ||
                            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

            if (isMobile && checkboxes.length > 1) {
                alert("ğŸ“±ç§»åŠ¨ç«¯æš‚ä¸æ”¯æŒå¤šä¸ªæ–‡ä»¶åŒæ—¶ä¸‹è½½ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶å¤¹æ‰“åŒ…ä¸‹è½½ï¼");
                return;
            }

            if (isMobile) {
                const meta_key = checkboxes[0].value;

                try {
                    const res = await fetch(`/api/download_url/${meta_key}`);
                    const data = await res.json();

                    if (!res.ok) {
                        alert(`âŒ ${meta_key}ï¼š${data.error || 'ä¸‹è½½å¤±è´¥'}`);
                        setTimeout(() => {
                            statusText.textContent = "";
                            location.reload();  // âœ… æ‰‹æœºç«¯ä¹Ÿåˆ·æ–°
                        }, 2000);
                        return;
                    }

                    window.location.href = data.url;
                    setTimeout(() => {
                        statusText.textContent = "";
                        location.reload();  // âœ… æ‰‹æœºç«¯ä¹Ÿåˆ·æ–°
                    }, 2000);
                    return;
                } catch (e) {
                    console.error(`ä¸‹è½½å¤±è´¥ï¼š${meta_key}`, e);
                    alert(`âŒ ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•`);
                }
                return;
            }
            downloadBtn.disabled = true;
            statusText.textContent = "æ­£åœ¨ä¸‹è½½ï¼Œè¯·å‹¿å…³é—­é¡µé¢...";
            for (const cb of checkboxes) {
                const meta_key = cb.value;
                try {
                    const res = await fetch(`/api/download_url/${meta_key}`);
                    const data = await res.json();

                    if (!res.ok) {
                        alert(`âŒ ${meta_key}ï¼š${data.error || 'ä¸‹è½½å¤±è´¥'}`);
                        continue;
                    }

                    const a = document.createElement('a');
                    a.href = data.url;
                    a.download = '';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    await new Promise(resolve => setTimeout(resolve, 200));
                } catch (e) {
                    console.error(`ä¸‹è½½å¤±è´¥ï¼š${meta_key}`, e);
                }
            }

            statusText.textContent = "ä¸‹è½½å®Œæˆ âœ…";
            downloadBtn.disabled = false;
            setTimeout(() => statusText.textContent = "", 2000);
            location.reload();
        }


        function handleMultiFolderDownload() {
            const checkboxes = document.querySelectorAll('input[name="folders"]:checked');
            if (checkboxes.length === 0) {
                alert("è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶å¤¹ï¼");
                return;
            }

            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

            if (isMobile && checkboxes.length > 1) {
                alert("ğŸ“±ç§»åŠ¨ç«¯æš‚ä¸æ”¯æŒå¤šä¸ªæ–‡ä»¶åŒæ—¶ä¸‹è½½ï¼Œè¯·ä¸‹è½½å•ä¸ªæ–‡ä»¶å¤¹ï¼");
                return;
            }

            checkboxes.forEach((cb) => {
                const folderId = cb.value;

                fetch(`/download_folder/${encodeURIComponent(folderId)}`, {
                    method: 'GET',
                    credentials: 'same-origin'  // âœ… ç¡®ä¿é™„å¸¦ session cookie
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('æ–‡ä»¶å¤¹ä¸‹è½½å¤±è´¥');
                    }
                    return response.blob();
                }).then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = folderId.split('/')[1] + '.zip'; // å– folder åä½œä¸ºæ–‡ä»¶å
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                }).catch(err => {
                    alert(`âŒ ${folderId} ä¸‹è½½å¤±è´¥ï¼š` + err.message);
                });
            });
        }

    </script>
</head>
<body>
<div class="container">
    <h2>ğŸ“ Mio's Netdisk</h2>
    <p>æ¬¢è¿å›æ¥ï¼Œ<strong>{{ username }}</strong>ï¼<a href="{{ url_for('logout') }}">[é€€å‡º]</a></p>
    <p>
        <button onclick="changeOwnPassword()" class="btn">ä¿®æ”¹å¯†ç </button>
    </p>
    {% if username == 'admin' %}
    <p>
        <a href="{{ url_for('admin_users') }}">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a> |
        <a href="{{ url_for('admin_uploads') }}">ğŸ“¤ ä¸Šä¼ è®°å½•</a> |
        <a href="{{ url_for('admin_logs') }}">ğŸ“¥ ä¸‹è½½è®°å½•</a>
    </p>
    {% endif %}

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash">
        {% for msg in messages %}
          <li>{{ msg }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="quota">
        <strong>ğŸ’¾ ç£ç›˜ç©ºé—´ï¼š</strong>
        å·²ç”¨ {{ (used_space / 1024 / 1024) | round(2) }} MB /
        {{ total_quota_mb | round(2) }} MB
        (å‰©ä½™ {{ ((total_space - used_space) / 1024 / 1024) | round(2) }} MB)
        <div class="progress-bar">
            <div class="progress" style="width: {{ (used_space / total_space) * 100 }}%"></div>
        </div>
    </div>

    <div style="margin: 10px 0; padding: 8px; background: #f9f9f9; border-left: 5px solid #999;">
        ğŸ“‚ å½“å‰è·¯å¾„ï¼š<strong>{{ folder_owner }}/{{ folder }}</strong>
    </div>

    <form method="POST" action="{{ url_for('delete_many') }}">
        <table border="1" cellpadding="6" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th style="white-space:nowrap;"><input type="checkbox" onclick="toggleAll(this)"></th>
                <th style="white-space:nowrap;">æ–‡ä»¶å
                    <span class="sort-arrow" onclick="sortTable(1, true)">â–²</span>
                    <span class="sort-arrow" onclick="sortTable(1, false)">â–¼</span>
                </th>
                <th style="white-space:nowrap;">å¤§å°
                    <span class="sort-arrow" onclick="sortTable(2, true)">â–²</span>
                    <span class="sort-arrow" onclick="sortTable(2, false)">â–¼</span>
                </th>
                <th style="white-space:nowrap;">ä¸Šä¼ æ—¶é—´
                    <span class="sort-arrow" onclick="sortTable(3, true)">â–²</span>
                    <span class="sort-arrow" onclick="sortTable(3, false)">â–¼</span>
                </th>
                <th style="white-space:nowrap;">ä¸Šä¼ è€…
                    <span class="sort-arrow" onclick="sortTable(4, true)">â–²</span>
                    <span class="sort-arrow" onclick="sortTable(4, false)">â–¼</span>
                </th>
                <th>æè¿°</th>
                <th style="white-space:nowrap;">ä¸‹è½½æ¬¡æ•°
                    <span class="sort-arrow" onclick="sortTable(6, true)">â–²</span>
                    <span class="sort-arrow" onclick="sortTable(6, false)">â–¼</span>
                </th>
                <!---<th>æ“ä½œ</th>-->
            </tr>
            </thead>



            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        {% if file.owner == username or folder_owner == username or username == 'admin' or file.folder_permission == 'public' %}
                            <input type="checkbox" name="files" value="{{ file.meta_key }}">
                        {% endif %}
                    </td>
                    <td>{{ file.name }}</td>
                    <td>{{ (file.size / 1024) | round(1) }} KB</td>
                    <td>{{ file.time }}</td>
                    <td>
                        {% if file.owner in deleted_users %}
                            <del style="color:red;">{{ file.owner }}</del>
                        {% else %}
                            {{ file.owner }}
                        {% endif %}
                    </td>
                    <td>{{ file.description or 'â€”' }}</td>
                    <td id="downloads-{{ loop.index0 }}">{{ file.downloads }}</td>
                    <!---
                    <td>
                        
                        <a href="javascript:void(0);"
                            onclick="handleDownload('{{ file.owner }}/{{ file.folder }}/{{ file.name }}', document.getElementById('downloads-{{ loop.index0 }}'))">
                            [ä¸‹è½½]
                        </a>

                        
                        {% if file.owner == username or username == 'admin' %}
                        <a href="{{ url_for('delete_file', encoded=file.owner ~ '/' ~ file.folder ~ '/' ~ file.name) }}" onclick="return confirm('ç¡®å®šè¦åˆ é™¤ {{ file.name }} å—ï¼Ÿ');">[åˆ é™¤]</a>
                        {% endif %}
                        
                    </td>
                    -->
                </tr>
                {% else %}
                <tr><td colspan="8">æš‚æ— æ–‡ä»¶</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <input type="hidden" name="folder" value="{{ folder }}">
        <input type="hidden" name="user" value="{{ folder_owner }}">

        <br>
        <button type="submit">åˆ é™¤</button>
        <button id="multiDownloadBtn" type="button" onclick="handleMultiDownload()">ä¸‹è½½</button>
        <span id="downloadStatus" style="margin-left: 10px; color: green;"></span>
        <p style="margin-top: 10px;">
            å…± <strong>{{ files|length }}</strong> ä¸ªæ–‡ä»¶ã€‚
        </p>
    </form>

    <hr>
    <h4>ğŸ“ åˆ›å»ºæ–°æ–‡ä»¶å¤¹</h4>
    <form method="POST" action="{{ url_for('create_folder') }}">
        <label>æ–‡ä»¶å¤¹åç§°ï¼š</label>
        <input type="text" name="folder_name" required>

        <label>æè¿°ï¼š</label>
        <input type="text" name="description" placeholder="å¯é€‰æè¿°">

        <label>æƒé™ï¼š</label>
        <select name="permission">
            <option value="private">ç§å¯†ï¼ˆä»…è‡ªå·±å¯è®¿é—®ï¼‰</option>
            <option value="public">å…¬å¼€ï¼ˆæ‰€æœ‰äººå¯è®¿é—®ï¼‰</option>
        </select>

        <button type="submit">åˆ›å»º</button>
    </form>

    <h4>ğŸ“‚ å¯è®¿é—®çš„æ–‡ä»¶å¤¹</h4>
        <form method="POST" action="{{ url_for('delete_folders') }}">
            <table border="1" cellpadding="6" cellspacing="0" width="100%" style="margin-bottom: 12px;">
                <thead>
                    <tr>
                        <th><input type="checkbox" onclick="toggleAllFolders(this)"> é€‰æ‹©</th>
                        <th>æ–‡ä»¶å¤¹</th>
                        <th>æƒé™</th>
                        <th>æè¿°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in folders %}
                    <tr>
                        <td align="center">
                            <!-- âœ… å°±æ˜¯è¿™é‡Œï¼ -->
                            <input type="checkbox" class="folder-checkbox" name="folders" value="{{ f.owner }}/{{ f.folder }}"
       title="åªæœ‰æœ‰æƒé™çš„æ–‡ä»¶å¤¹ä¼šè¢«å¤„ç†ï¼Œå…¶ä»–å°†è‡ªåŠ¨å¿½ç•¥">

                        </td>
                        <td>
                            {% if f.owner == folder_owner and f.folder == folder %}
                                <strong>ğŸ“ {{ f.folder }}</strong>
                            {% else %}
                                <a href="{{ url_for('dashboard') }}?folder={{ f.folder }}&user={{ f.owner }}">
                                    ğŸ“ {{ f.folder }} <span style="color:gray;">({{ f.owner }})</span>
                                </a>
                            {% endif %}
                        </td>
                        <td>{{ f.permission }}</td>
                        <td>{{ f.description or 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- âœ… æ”¾åœ¨ form é‡Œé¢ -->
            <button type="submit" onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ‰€é€‰æ–‡ä»¶å¤¹ï¼Ÿ');">åˆ é™¤æ–‡ä»¶å¤¹</button>
            <button type="button" onclick="handleMultiFolderDownload()">ä¸‹è½½æ–‡ä»¶å¤¹</button>
        </form>
        <hr>
        
    <h4>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h4>
    <form id="uploadForm">
        <input type="hidden" id="folderInput" value="{{ folder }}">
        <input type="hidden" id="ownerInput" value="{{ folder_owner }}">
        <input type="file" id="fileInput" name="file" multiple required><br><br>
        <label>ğŸ“ æè¿°ï¼š</label><br>
        <input type="text" id="descriptionInput" placeholder="å¯é€‰æ–‡ä»¶æè¿°..." style="width: 100%; padding: 6px;"><br><br>
        <button type="submit">ä¸Šä¼ </button>
    </form>

    <!-- æ˜¾ç¤ºè¿›åº¦ -->
    <div id="progressContainer"></div>

    <script>
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const files = document.getElementById('fileInput').files;
        const desc = document.getElementById('descriptionInput').value;
        const container = document.getElementById('progressContainer');
        container.innerHTML = '';

        let completed = 0;

        for (const file of files) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("description", desc);
            formData.append("folder", document.getElementById("folderInput").value);  // âœ… æ–°å¢
            formData.append("user", document.getElementById("ownerInput").value);    // âœ… æ–°å¢

            const progressBarWrapper = document.createElement('div');
            progressBarWrapper.style.marginBottom = '10px';
            progressBarWrapper.innerHTML = `
                <div><strong>${file.name}</strong></div>
                <progress value="0" max="100" style="width: 300px;"></progress>
                <span>0%</span>
            `;
            container.appendChild(progressBarWrapper);

            const progressBar = progressBarWrapper.querySelector('progress');
            const progressText = progressBarWrapper.querySelector('span');

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload_one", true);

            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.value = percent;
                    progressText.innerText = percent + '%';
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    progressText.innerText = 'âœ… ä¸Šä¼ æˆåŠŸ';
                } else {
                    progressText.innerText = 'âŒ ä¸Šä¼ å¤±è´¥';
                }
                completed += 1;
                if (completed === files.length) {
                    setTimeout(() => location.reload(), 1000);  // æ‰€æœ‰ä¸Šä¼ å®Œæ¯•å 1 ç§’åˆ·æ–°
                }
            };

            xhr.send(formData);
        }
    });
    </script>

</div>
</body>
</html>









